<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>印表機伺服器監控中心</title>
    
    <!-- [離線模式] 載入本地整合後的資源 -->
    <link rel="stylesheet" href="offline/bundle.css">
    <script src="offline/tailwind.js"></script>
    <script src="offline/bundle.js"></script>

    <!-- Tailwind 設定：啟用 class 模式的 Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', // 自訂深色背景
                            950: '#0f172a'  // 自訂更深背景
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* 自訂捲軸 (支援深色) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-200 font-sans h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <div id="app" v-cloak class="flex-1 flex flex-col h-full">
        
        <!-- 頂部導航列 -->
        <header class="bg-white dark:bg-slate-900 shadow-sm border-b border-slate-200 dark:border-slate-800 z-20 transition-colors">
            <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-500/30">
                        <i class="fa-solid fa-print text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight">Print Server Monitor</h1>
                        <p class="text-xs text-slate-500 dark:text-slate-400 hidden sm:block">系統維運儀表板 v1.5 (Dark Mode)</p>
                    </div>
                </div>

                <!-- 連線設定區 -->
                <div class="flex items-center gap-3 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg border border-slate-200 dark:border-slate-700 transition-colors">
                    
                    <!-- 深色模式切換 -->
                    <button @click="toggleDarkMode" class="w-8 h-8 rounded-full bg-white dark:bg-slate-700 text-slate-600 dark:text-yellow-400 shadow-sm border border-slate-200 dark:border-slate-600 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-slate-600 transition-all mr-2" :title="darkMode ? '切換為亮色' : '切換為深色'">
                        <i class="fa-solid" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i>
                    </button>

                    <div class="flex flex-col sm:flex-row gap-2">
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-slate-400"><i class="fa-solid fa-server"></i></span>
                            <input type="text" v-model="config.ip" placeholder="伺服器 IP" 
                                   class="pl-9 pr-3 py-1.5 text-sm rounded border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-blue-500 focus:border-blue-500 w-40 transition-colors">
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-slate-400"><i class="fa-solid fa-key"></i></span>
                            <input type="password" v-model="config.key" placeholder="API Key" 
                                   class="pl-9 pr-3 py-1.5 text-sm rounded border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-blue-500 focus:border-blue-500 w-28 transition-colors">
                        </div>
                    </div>
                    <button @click="fetchPrinters(true)" :disabled="loading"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 shadow-md shadow-blue-500/20">
                        <i class="fa-solid fa-rotate" :class="{'fa-spin': loading}"></i>
                        <span class="hidden sm:inline">連線</span>
                    </button>
                    <!-- 自動更新開關 -->
                    <div class="flex items-center ml-2 border-l border-slate-300 dark:border-slate-600 pl-3">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="autoRefresh" class="sr-only peer">
                            <div class="relative w-9 h-5 bg-gray-200 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            <span class="ms-2 text-xs font-medium text-gray-700 dark:text-slate-300">自動</span>
                        </label>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主內容區 -->
        <main class="flex-1 overflow-hidden flex flex-col md:flex-row max-w-8xl mx-auto w-full">
            
            <!-- 左側側邊欄 -->
            <aside class="w-full md:w-64 bg-slate-50 dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 p-4 overflow-y-auto flex-shrink-0 transition-colors">
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">伺服器全域操作</h3>
                    <div class="space-y-2">
                        <button @click="restartSpooler" class="w-full text-left px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:shadow-md hover:border-blue-300 dark:hover:border-blue-500 transition-all group">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-slate-700 dark:text-slate-200 group-hover:text-blue-600 dark:group-hover:text-blue-400">重啟 Spooler</span>
                                <i class="fa-solid fa-arrows-rotate text-slate-400 group-hover:text-blue-500"></i>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">強制重啟列印服務</p>
                        </button>
                        
                        <button @click="selfHeal" class="w-full text-left px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:shadow-md hover:border-red-300 dark:hover:border-red-500 transition-all group">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-slate-700 dark:text-slate-200 group-hover:text-red-600 dark:group-hover:text-red-400">深度自癒修復</span>
                                <i class="fa-solid fa-suitcase-medical text-slate-400 group-hover:text-red-500"></i>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">清空暫存並重置環境</p>
                        </button>

                        <button @click="showLogs" class="w-full text-left px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:shadow-md hover:border-emerald-300 dark:hover:border-emerald-500 transition-all group">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-slate-700 dark:text-slate-200 group-hover:text-emerald-600 dark:group-hover:text-emerald-400">檢視系統日誌</span>
                                <i class="fa-solid fa-file-lines text-slate-400 group-hover:text-emerald-500"></i>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">查看最近 500 行紀錄</p>
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">狀態概覽</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-white dark:bg-slate-800 p-3 rounded border border-slate-200 dark:border-slate-700 text-center transition-colors">
                            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ printers.length }}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">監控總數</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-3 rounded border border-slate-200 dark:border-slate-700 text-center transition-colors">
                            <div class="text-2xl font-bold text-red-500 dark:text-red-400">{{ errorCount }}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">異常數量</div>
                        </div>
                    </div>
                </div>
                
                <div class="text-xs text-slate-400 dark:text-slate-500 text-center mt-auto">
                    最後更新: {{ lastUpdated || '尚未連線' }}
                </div>
            </aside>

            <!-- 右側內容區 -->
            <section class="flex-1 overflow-y-auto bg-slate-50 dark:bg-slate-950 p-4 sm:p-6 relative transition-colors">
                
                <!-- 搜尋與篩選 -->
                <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-between items-center">
                    <div class="relative w-full sm:w-96">
                        <span class="absolute left-3 top-2.5 text-slate-400"><i class="fa-solid fa-search"></i></span>
                        <input type="text" v-model="searchQuery" placeholder="搜尋名稱、IP、狀態..." 
                               class="w-full pl-10 pr-4 py-2 rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-colors">
                    </div>
                    <div class="flex gap-2 flex-wrap justify-center">
                         <button @click="filterStatus = ''" 
                            :class="filterStatus === '' ? 'bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-900 border-transparent' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'" 
                            class="px-3 py-1 text-xs rounded-full border transition-all shadow-sm">全部</button>
                         
                         <button @click="filterStatus = 'Ready'" 
                            :class="filterStatus === 'Ready' ? 'bg-emerald-600 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'" 
                            class="px-3 py-1 text-xs rounded-full border transition-all shadow-sm">就緒</button>

                         <button @click="filterStatus = 'Issue'" 
                            :class="filterStatus === 'Issue' ? 'bg-orange-600 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'" 
                            class="px-3 py-1 text-xs rounded-full border transition-all shadow-sm">錯誤+警示</button>
                         
                         <button @click="filterStatus = 'Error'" 
                            :class="filterStatus === 'Error' ? 'bg-red-600 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'" 
                            class="px-3 py-1 text-xs rounded-full border transition-all shadow-sm">異常</button>
                         
                         <button @click="filterStatus = 'Warning'" 
                            :class="filterStatus === 'Warning' ? 'bg-amber-500 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'" 
                            class="px-3 py-1 text-xs rounded-full border transition-all shadow-sm">警告</button>
                    </div>
                </div>

                <!-- 列表 Grid -->
                <div v-if="filteredPrinters.length > 0" class="grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-4">
                    <div v-for="p in filteredPrinters" :key="p.Name" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4 hover:shadow-md transition-all relative group">
                        
                        <!-- 狀態燈號條 -->
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 rounded-l-xl" :class="getStatusColor(p.Status, true)"></div>

                        <div class="pl-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="overflow-hidden">
                                    <h3 class="font-bold text-slate-800 dark:text-slate-100 text-lg truncate pr-2" :title="p.Name">{{ p.Name }}</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium" :class="getStatusColor(p.Status)">
                                            <i class="fa-solid fa-circle text-[8px] mr-1.5"></i>
                                            {{ p.Status }}
                                        </span>
                                        <span v-if="p.IP" class="text-xs font-mono text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                                            <i class="fa-solid fa-network-wired mr-1"></i>{{ p.IP }}
                                        </span>
                                    </div>
                                </div>
                                <div class="text-right flex-shrink-0 ml-2">
                                    <div class="text-2xl font-bold" :class="p.Jobs > 0 ? (p.Jobs > 20 ? 'text-red-600 dark:text-red-400' : 'text-blue-600 dark:text-blue-400') : 'text-slate-400 dark:text-slate-600'">
                                        {{ p.Jobs }}
                                    </div>
                                    <div class="text-[10px] text-slate-400 dark:text-slate-500 uppercase">佇列數</div>
                                </div>
                            </div>

                            <!-- 錯誤細節 -->
                            <div v-if="p.ErrorDetails" class="mb-3 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 text-xs px-2 py-1.5 rounded border border-red-100 dark:border-red-900/50 flex items-start gap-2">
                                <i class="fa-solid fa-triangle-exclamation mt-0.5"></i>
                                <span>{{ p.ErrorDetails }}</span>
                            </div>
                            
                             <!-- 註解 -->
                             <div v-if="p.Comment" class="mb-3 text-xs text-slate-500 dark:text-slate-400 italic">
                                <i class="fa-regular fa-comment-dots mr-1"></i>{{ p.Comment }}
                            </div>

                            <!-- 資訊欄 -->
                            <div class="grid grid-cols-2 gap-y-1 text-xs text-slate-500 dark:text-slate-400 mb-4 border-t border-slate-100 dark:border-slate-700 pt-2">
                                <div v-if="p.Location" class="truncate" :title="p.Location"><i class="fa-solid fa-location-dot w-4"></i> {{ p.Location }}</div>
                                <div v-if="p.Driver" class="truncate col-span-2" :title="p.Driver"><i class="fa-solid fa-microchip w-4"></i> {{ p.Driver }}</div>
                                <div v-if="p.PortName" class="truncate"><i class="fa-solid fa-plug w-4"></i> {{ p.PortName }}</div>
                            </div>

                            <!-- 操作按鈕 -->
                            <div class="flex gap-2 mt-auto pt-2 border-t border-slate-100 dark:border-slate-700">
                                <button @click="refreshPrinter(p.Name)" title="重新整理連線" class="flex-1 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200 text-xs py-2 rounded border border-slate-200 dark:border-slate-600 transition-colors">
                                    <i class="fa-solid fa-sync"></i> 刷新
                                </button>
                                <button @click="openPdfModal(p)" title="上傳 PDF 列印" class="flex-1 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-300 text-xs py-2 rounded border border-blue-200 dark:border-blue-800 transition-colors">
                                    <i class="fa-solid fa-file-pdf"></i> 列印
                                </button>
                                <button @click="clearQueue(p.Name)" title="清除佇列" class="flex-1 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 text-red-600 dark:text-red-300 text-xs py-2 rounded border border-red-200 dark:border-red-800 transition-colors">
                                    <i class="fa-solid fa-trash"></i> 清除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 無資料顯示 -->
                <div v-else-if="!loading" class="flex flex-col items-center justify-center h-96 text-slate-400 dark:text-slate-600">
                    <i class="fa-solid fa-ghost text-4xl mb-4"></i>
                    <p>找不到符合的印表機</p>
                </div>
                
                <!-- 載入中遮罩 -->
                <div v-if="loading && printers.length === 0" class="absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-10">
                    <div class="flex flex-col items-center">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-3"></i>
                        <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">正在連線至 API...</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- PDF 上傳 Modal -->
        <transition name="fade">
            <div v-if="showPdfModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md overflow-hidden transition-colors">
                    <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                        <h3 class="font-bold text-slate-700 dark:text-slate-200"><i class="fa-solid fa-print mr-2 text-blue-600 dark:text-blue-400"></i>上傳 PDF 列印</h3>
                        <button @click="showPdfModal = false" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-sm text-blue-800 dark:text-blue-200 mb-4">
                            <span class="font-bold">目標：</span> {{ selectedPrinter?.Name }}
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">選擇檔案 (PDF)</label>
                            <input type="file" ref="fileInput" accept=".pdf" class="block w-full text-sm text-slate-500 dark:text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-900/50 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 transition-all border border-slate-200 dark:border-slate-600 rounded-lg cursor-pointer bg-white dark:bg-slate-700">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">列印模式</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" v-model="pdfDuplex" value="0" class="peer sr-only">
                                    <div class="text-center py-2 border dark:border-slate-600 rounded hover:bg-slate-50 dark:hover:bg-slate-700 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all text-sm text-slate-600 dark:text-slate-300">單面</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" v-model="pdfDuplex" value="1" class="peer sr-only">
                                    <div class="text-center py-2 border dark:border-slate-600 rounded hover:bg-slate-50 dark:hover:bg-slate-700 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all text-sm text-slate-600 dark:text-slate-300">雙面(長邊)</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" v-model="pdfDuplex" value="2" class="peer sr-only">
                                    <div class="text-center py-2 border dark:border-slate-600 rounded hover:bg-slate-50 dark:hover:bg-slate-700 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all text-sm text-slate-600 dark:text-slate-300">雙面(短邊)</div>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="px-6 py-4 bg-slate-50 dark:bg-slate-900 flex justify-end gap-3 border-t border-slate-100 dark:border-slate-800">
                        <button @click="showPdfModal = false" class="px-4 py-2 text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-medium">取消</button>
                        <button @click="submitPdf" :disabled="uploading" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium disabled:opacity-50 flex items-center gap-2 shadow-lg shadow-blue-500/20">
                            <i v-if="uploading" class="fa-solid fa-spinner fa-spin"></i>
                            {{ uploading ? '傳送中...' : '確認列印' }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Log Viewer Modal -->
        <transition name="fade">
            <div v-if="showLogModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col transition-colors">
                    <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                        <h3 class="font-bold text-slate-700 dark:text-slate-200"><i class="fa-solid fa-terminal mr-2 text-emerald-600"></i>伺服器日誌 (Server Logs)</h3>
                        <div class="flex items-center gap-3">
                            <button @click="fetchLogs" class="text-sm text-blue-600 dark:text-blue-400 hover:underline"><i class="fa-solid fa-sync mr-1"></i>重新整理</button>
                            <button @click="showLogModal = false" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="fa-solid fa-xmark text-xl"></i></button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto bg-slate-900 p-4 font-mono text-xs text-green-400 leading-relaxed whitespace-pre-wrap" id="logContent">
                        <div v-if="logsLoading" class="text-center py-10 text-slate-500"><i class="fa-solid fa-spinner fa-spin text-2xl"></i><br>載入中...</div>
                        <div v-else>{{ logData || '暫無日誌資料...' }}</div>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // 狀態變數: 優先從 localStorage 讀取
                const config = ref({
                    ip: localStorage.getItem('ps_server_ip') || '',
                    key: localStorage.getItem('ps_api_key') || ''
                });
                
                const autoRefresh = ref(localStorage.getItem('ps_auto_refresh') === 'true');
                const darkMode = ref(localStorage.getItem('ps_dark_mode') === 'true');

                const printers = ref([]);
                const loading = ref(false);
                const lastUpdated = ref('');
                const searchQuery = ref('');
                const filterStatus = ref(''); // 預設全部
                
                // PDF Modal
                const showPdfModal = ref(false);
                const selectedPrinter = ref(null);
                const pdfDuplex = ref("0");
                const uploading = ref(false);
                const fileInput = ref(null);

                // Logs Modal
                const showLogModal = ref(false);
                const logData = ref('');
                const logsLoading = ref(false);

                let pollTimer = null;

                // 監聽並儲存設定
                watch(config, (newVal) => {
                    localStorage.setItem('ps_server_ip', newVal.ip);
                    localStorage.setItem('ps_api_key', newVal.key);
                }, { deep: true });

                watch(autoRefresh, (newVal) => {
                    localStorage.setItem('ps_auto_refresh', newVal);
                    if (newVal) {
                        startPolling();
                        toast("已啟用自動更新 (60s)");
                    } else {
                        stopPolling();
                        toast("已停用自動更新");
                    }
                });

                // 深色模式邏輯
                watch(darkMode, (val) => {
                    localStorage.setItem('ps_dark_mode', val);
                    if (val) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                }, { immediate: true });

                const toggleDarkMode = () => {
                    darkMode.value = !darkMode.value;
                };

                function startPolling() {
                    if (pollTimer) clearInterval(pollTimer);
                    pollTimer = setInterval(() => fetchPrinters(false), 60000);
                }

                function stopPolling() {
                    if (pollTimer) clearInterval(pollTimer);
                }

                const getApiUrl = (path) => `http://${config.value.ip}:8888${path}`;

                const fetchPrinters = async (showToast = false) => {
                    if (!config.value.ip) {
                        if (showToast) error("請輸入伺服器 IP");
                        return;
                    }

                    loading.value = true;
                    try {
                        const res = await axios.get(getApiUrl('/printers'), {
                            headers: { 'X-API-KEY': config.value.key }
                        });
                        
                        if (res.data.success) {
                            printers.value = res.data.data;
                            lastUpdated.value = new Date().toLocaleString();
                            if (showToast) success("連線成功，資料已更新");
                        } else {
                            error(res.data.message || "無法取得資料");
                        }
                    } catch (err) {
                        console.error(err);
                        error("連線失敗: " + (err.message || "無法連接伺服器"));
                        autoRefresh.value = false; 
                    } finally {
                        loading.value = false;
                    }
                };

                // 篩選邏輯 (支援 Ready, Issue, Error, Warning)
                const filteredPrinters = computed(() => {
                    return printers.value.filter(p => {
                        const matchQuery = 
                            p.Name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                            p.IP.includes(searchQuery.value) ||
                            p.Status.toLowerCase().includes(searchQuery.value.toLowerCase());
                        
                        let matchStatus = true;
                        if (filterStatus.value === 'Ready') matchStatus = p.Status === 'Ready';
                        else if (filterStatus.value === 'Error') matchStatus = p.Status === 'Error';
                        else if (filterStatus.value === 'Warning') matchStatus = p.Status.includes('Warning');
                        else if (filterStatus.value === 'Issue') matchStatus = p.Status === 'Error' || p.Status.includes('Warning');

                        return matchQuery && matchStatus;
                    });
                });

                const errorCount = computed(() => printers.value.filter(p => p.Status === 'Error' || p.Status.includes('Warning')).length);

                const getStatusColor = (status, isBorder = false) => {
                    if (status === 'Ready') return isBorder ? 'bg-emerald-500' : 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400';
                    if (status === 'Printing') return isBorder ? 'bg-blue-500' : 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400 animate-pulse';
                    if (status === 'Warmup') return isBorder ? 'bg-yellow-500' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400';
                    if (status === 'Offline') return isBorder ? 'bg-slate-400' : 'bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-400';
                    if (status.includes('Error')) return isBorder ? 'bg-red-500' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400';
                    return isBorder ? 'bg-amber-500' : 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400';
                };

                const performAction = async (endpoint, successMsg) => {
                    loading.value = true;
                    try {
                        const res = await axios.get(getApiUrl(endpoint), {
                            headers: { 'X-API-KEY': config.value.key }
                        });
                        if (res.data.success) {
                            success(res.data.message || successMsg);
                            fetchPrinters(false);
                        } else {
                            error(res.data.message);
                        }
                    } catch (err) {
                        error("操作失敗: " + err.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const clearQueue = async (name) => {
                    if (!confirm(`確定要清除 [${name}] 的所有工作嗎？`)) return;
                    await performAction(`/printer/clear?name=${encodeURIComponent(name)}`, "佇列已清除");
                };

                const refreshPrinter = async (name) => {
                    await performAction(`/printer/refresh?name=${encodeURIComponent(name)}`, "重新整理指令已發送");
                };

                const restartSpooler = async () => {
                    if (!confirm("警告：重啟 Spooler 會暫時中斷所有列印服務。確定要執行嗎？")) return;
                    await performAction(`/service/restart-spooler`, "服務重啟指令已發送");
                };

                const selfHeal = async () => {
                    if (!confirm("危險操作：深度自癒將刪除所有暫存檔並強制重啟服務。請確認目前無重要列印工作中。")) return;
                    await performAction(`/service/self-heal`, "深度自癒流程已啟動");
                };

                const openPdfModal = (printer) => {
                    selectedPrinter.value = printer;
                    pdfDuplex.value = "0";
                    showPdfModal.value = true;
                };

                const submitPdf = async () => {
                    const file = fileInput.value.files[0];
                    if (!file) return error("請選擇 PDF 檔案");
                    
                    uploading.value = true;
                    try {
                        const url = getApiUrl(`/printer/print-pdf?name=${encodeURIComponent(selectedPrinter.value.Name)}&duplex=${pdfDuplex.value}`);
                        const res = await axios.post(url, file, {
                            headers: { 
                                'X-API-KEY': config.value.key,
                                'Content-Type': 'application/pdf'
                            }
                        });

                        if (res.data.success) {
                            success("PDF 已成功發送至列印佇列");
                            showPdfModal.value = false;
                            fileInput.value.value = '';
                        } else {
                            error(res.data.message);
                        }
                    } catch (err) {
                        error("上傳失敗: " + err.message);
                    } finally {
                        uploading.value = false;
                    }
                };

                const showLogs = () => {
                    showLogModal.value = true;
                    fetchLogs();
                };

                const fetchLogs = async () => {
                    logsLoading.value = true;
                    try {
                        const res = await axios.get(getApiUrl('/server/logs?lines=500'), {
                            headers: { 'X-API-KEY': config.value.key }
                        });
                        if (res.data.success) {
                            logData.value = Array.isArray(res.data.data) ? res.data.data.join('\n') : res.data.data;
                            setTimeout(() => {
                                const el = document.getElementById('logContent');
                                if(el) el.scrollTop = el.scrollHeight;
                            }, 100);
                        } else {
                            logData.value = "無日誌資料或讀取失敗: " + res.data.message;
                        }
                    } catch (err) {
                        logData.value = "連線錯誤: " + err.message;
                    } finally {
                        logsLoading.value = false;
                    }
                };

                // Toast Helper
                const toast = (text, bg = "#3b82f6") => {
                    Toastify({
                        text: text,
                        duration: 3000,
                        gravity: "bottom", 
                        position: "right", 
                        style: { background: bg, borderRadius: "8px", fontSize: "14px" }
                    }).showToast();
                };
                const success = (text) => toast(text, "#10b981");
                const error = (text) => toast(text, "#ef4444");

                onMounted(() => {
                    if (config.value.ip && config.value.key) {
                        fetchPrinters();
                        if (autoRefresh.value) {
                            startPolling();
                        }
                    }
                });

                return {
                    config, printers, loading, lastUpdated, autoRefresh, darkMode,
                    searchQuery, filterStatus, filteredPrinters, errorCount,
                    getStatusColor, toggleDarkMode,
                    fetchPrinters, 
                    clearQueue, refreshPrinter, restartSpooler, selfHeal,
                    showPdfModal, selectedPrinter, pdfDuplex, uploading, fileInput, openPdfModal, submitPdf,
                    showLogModal, logData, logsLoading, showLogs, fetchLogs
                };
            }
        }).mount('#app');
    </script>
</body>
</html>