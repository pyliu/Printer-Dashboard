<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>印表機伺服器監控中心</title>
    
    <link rel="stylesheet" href="offline/bundle.css">
    <script src="offline/tailwind.js"></script>
    <script src="offline/bundle.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 950: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <style>
        [v-cloak] { display: none !important; }
        
        #init-loading { transition: opacity 0.5s ease-out; }
        .fade-out { opacity: 0; pointer-events: none; }
        
        .list-move { transition: transform 1.0s cubic-bezier(0.4, 0, 0.2, 1) !important; z-index: 10; }
        .list-enter-active, .list-leave-active { transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1) !important; }
        .list-leave-active { position: absolute; width: 100%; z-index: 0; }
        .list-enter-from { opacity: 0; transform: translateY(30px); }
        .list-leave-to { opacity: 0; transform: translateY(-30px); }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-200 font-sans h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <div id="init-loading" class="fixed inset-0 bg-slate-50 dark:bg-slate-950 z-[100] flex flex-col items-center justify-center">
        <div class="text-center">
            <svg class="animate-spin h-12 w-12 text-blue-600 mb-4 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">系統資源讀取中...</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">正在初始化 Print Server Monitor 儀表板</p>
        </div>
    </div>

    <div id="app" v-cloak class="flex-1 flex flex-col h-full">
        
        <!-- Header -->
        <header class="bg-white dark:bg-slate-900 shadow-sm border-b border-slate-200 dark:border-slate-800 z-20 transition-colors">
            <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-500/30"><i class="fa-solid fa-print text-xl"></i></div>
                    <div>
                        <div class="flex items-center gap-2">
                            <h1 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight">Print Server Monitor</h1>
                            <span v-if="isDemoMode" class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full animate-pulse shadow-sm">DEMO MODE</span>
                        </div>
                        <p class="text-xs text-slate-500 dark:text-slate-400 hidden sm:block">系統維運儀表板 v4.0 (Advanced Ops)</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg border border-slate-200 dark:border-slate-700 transition-colors">
                    <button @click="toggleDarkMode" class="w-8 h-8 rounded-full bg-white dark:bg-slate-700 text-slate-600 dark:text-yellow-400 shadow-sm border border-slate-200 dark:border-slate-600 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-slate-600 transition-all mr-2"><i class="fa-solid" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i></button>

                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fa-solid fa-server text-slate-400"></i></div>
                        <select v-model="currentServerId" @change="switchServer" :disabled="isDemoMode" class="pl-9 pr-8 py-1.5 text-sm rounded border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-blue-500 focus:border-blue-500 w-48 transition-colors appearance-none cursor-pointer disabled:opacity-70 disabled:cursor-not-allowed">
                            <option value="" disabled>請選擇伺服器</option>
                            <option v-for="srv in servers" :key="srv.id" :value="srv.id">{{ srv.name }} ({{ srv.ip }})</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none"><i class="fa-solid fa-chevron-down text-xs text-slate-400"></i></div>
                    </div>

                    <button @click="openServerManager" :disabled="isDemoMode" class="bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 text-slate-700 dark:text-slate-200 px-3 py-1.5 rounded text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="管理伺服器列表"><i class="fa-solid fa-gear"></i></button>

                    <button @click="fetchPrinters(true)" :disabled="loading || (!currentServerId && !isDemoMode)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-md shadow-blue-500/20 disabled:shadow-none">
                        <i class="fa-solid fa-rotate" :class="{'fa-spin': loading}"></i><span class="hidden sm:inline">連線</span>
                    </button>
                    
                    <div class="flex items-center ml-2 border-l border-slate-300 dark:border-slate-600 pl-3 gap-2">
                        <label class="inline-flex items-center cursor-pointer" title="開啟/關閉自動更新">
                            <input type="checkbox" v-model="autoRefresh" :disabled="(!isConfigValid && !isDemoMode)" class="sr-only peer">
                            <div class="relative w-9 h-5 bg-gray-200 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600 peer-disabled:opacity-50 peer-disabled:cursor-not-allowed"></div>
                        </label>
                        <div v-if="autoRefresh" class="flex items-center transition-all animate-fade-in-right bg-white dark:bg-slate-700 rounded border border-slate-300 dark:border-slate-600 px-1">
                            <input type="number" v-model.lazy="refreshInterval" @change="validateInterval" min="60" class="w-10 px-0.5 py-0.5 text-xs text-center bg-transparent border-none text-slate-700 dark:text-slate-200 focus:ring-0 appearance-none" title="更新間隔 (秒)">
                            <span class="text-[10px] text-slate-500 dark:text-slate-400 mr-1">s</span>
                            <div class="w-[1px] h-3 bg-slate-300 dark:bg-slate-600 mx-1"></div>
                            <span class="text-xs font-mono font-bold text-blue-600 dark:text-blue-400 w-5 text-right">{{ countdown }}</span>
                        </div>
                        <span v-else class="text-xs font-medium text-gray-700 dark:text-slate-300" :class="{'opacity-50': !isConfigValid && !isDemoMode}">自動</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-hidden flex flex-col md:flex-row max-w-8xl mx-auto w-full">
            <aside class="w-full md:w-64 bg-slate-50 dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 p-4 overflow-y-auto flex-shrink-0 transition-colors">
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">伺服器全域操作</h3>
                    <div class="space-y-2">
                        <!-- 一般操作 -->
                        <button @click="restartSpooler" :disabled="loading || (!isConfigValid && !isDemoMode)" class="w-full text-left px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:shadow-md hover:border-blue-300 dark:hover:border-blue-500 transition-all group disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                            <div class="flex items-center justify-between"><span class="font-medium text-slate-700 dark:text-slate-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 group-disabled:text-slate-400">重啟 Spooler</span><i class="fa-solid fa-arrows-rotate text-slate-400 group-hover:text-blue-500 group-disabled:text-slate-300"></i></div>
                            <p class="text-xs text-slate-400 mt-1">強制重啟列印服務</p>
                        </button>
                        
                        <button @click="selfHeal" :disabled="loading || (!isConfigValid && !isDemoMode)" class="w-full text-left px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:shadow-md hover:border-red-300 dark:hover:border-red-500 transition-all group disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                            <div class="flex items-center justify-between"><span class="font-medium text-slate-700 dark:text-slate-200 group-hover:text-red-600 dark:group-hover:text-red-400 group-disabled:text-slate-400">深度自癒修復</span><i class="fa-solid fa-suitcase-medical text-slate-400 group-hover:text-red-500 group-disabled:text-slate-300"></i></div>
                            <p class="text-xs text-slate-400 mt-1">清空暫存並重置環境</p>
                        </button>

                        <button @click="showLogs" :disabled="loading || (!isConfigValid && !isDemoMode)" class="w-full text-left px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:shadow-md hover:border-emerald-300 dark:hover:border-emerald-500 transition-all group disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                            <div class="flex items-center justify-between"><span class="font-medium text-slate-700 dark:text-slate-200 group-hover:text-emerald-600 dark:group-hover:text-emerald-400 group-disabled:text-slate-400">檢視系統日誌</span><i class="fa-solid fa-file-lines text-slate-400 group-hover:text-emerald-500 group-disabled:text-slate-300"></i></div>
                            <p class="text-xs text-slate-400 mt-1">查看最近 500 行紀錄</p>
                        </button>

                        <!-- [新增] 進階操作切換開關 -->
                        <button @click="showAdvancedOps = !showAdvancedOps" class="w-full py-2 text-xs text-center text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 border border-dashed border-slate-300 dark:border-slate-600 rounded hover:bg-slate-100 dark:hover:bg-slate-800/50 transition-all mt-4 mb-2 flex items-center justify-center gap-2">
                            <i class="fa-solid" :class="showAdvancedOps ? 'fa-angle-up' : 'fa-angle-down'"></i>
                            {{ showAdvancedOps ? '隱藏高風險操作' : '顯示進階系統操作' }}
                        </button>

                        <!-- [新增] 危險操作區塊 (預設隱藏) -->
                        <transition name="fade">
                            <div v-if="showAdvancedOps" class="space-y-2 p-3 bg-slate-100 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700">
                                <div class="text-[10px] text-slate-400 text-center mb-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i>請謹慎操作</div>
                                
                                <button @click="restartScript" :disabled="loading || (!isConfigValid && !isDemoMode)" class="w-full text-left px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded shadow-sm hover:border-purple-400 dark:hover:border-purple-500 transition-all group disabled:opacity-50 disabled:cursor-not-allowed">
                                    <div class="flex items-center justify-between"><span class="font-medium text-sm text-slate-700 dark:text-slate-200 group-hover:text-purple-600 dark:group-hover:text-purple-400">重啟 API 服務</span><i class="fa-solid fa-power-off text-slate-400 group-hover:text-purple-500 text-xs"></i></div>
                                </button>
                                
                                <button @click="restartServer" :disabled="loading || (!isConfigValid && !isDemoMode)" class="w-full text-left px-3 py-2 bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800 rounded shadow-sm hover:border-red-400 dark:hover:border-red-500 transition-all group disabled:opacity-50 disabled:cursor-not-allowed">
                                    <div class="flex items-center justify-between"><span class="font-medium text-sm text-red-700 dark:text-red-400 group-hover:text-red-800 dark:group-hover:text-red-300">重啟伺服器</span><i class="fa-solid fa-display text-red-400 group-hover:text-red-600 text-xs"></i></div>
                                </button>
                            </div>
                        </transition>

                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">狀態概覽</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-white dark:bg-slate-800 p-3 rounded border border-slate-200 dark:border-slate-700 text-center transition-colors"><div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ printers.length }}</div><div class="text-xs text-slate-500 dark:text-slate-400">監控總數</div></div>
                        <div class="bg-white dark:bg-slate-800 p-3 rounded border border-slate-200 dark:border-slate-700 text-center transition-colors"><div class="text-2xl font-bold text-red-500 dark:text-red-400">{{ errorCount }}</div><div class="text-xs text-slate-500 dark:text-slate-400">異常數量</div></div>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">相關檔案下載</h3>
                    <div class="space-y-2">
                        <a v-for="file in downloadFiles" 
                           :key="file.url" 
                           :href="file.url" 
                           target="_blank" 
                           @click="handleDownload($event)"
                           class="block w-full px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:shadow-md hover:border-blue-300 dark:hover:border-blue-500 transition-all group cursor-pointer">
                            <div class="flex items-center"><i :class="file.icon" class="w-5 text-center mr-2"></i><span class="text-slate-700 dark:text-slate-200 text-xs group-hover:text-blue-600 dark:group-hover:text-blue-400">{{ file.name }}</span><i class="fa-solid fa-up-right-from-square ml-auto text-slate-300 group-hover:text-blue-500 text-[10px]"></i></div>
                        </a>
                    </div>
                </div>
                <div class="text-xs text-slate-400 dark:text-slate-500 text-center mt-auto pb-4">最後更新: {{ lastUpdated || '尚未連線' }}</div>
            </aside>

            <section class="flex-1 overflow-y-auto bg-slate-50 dark:bg-slate-950 p-4 sm:p-6 relative transition-colors">
                <div class="mb-6 flex flex-col xl:flex-row gap-4 justify-between items-start xl:items-center">
                    <div class="flex flex-col sm:flex-row gap-4 w-full xl:w-auto">
                        <div class="relative w-full sm:w-60"><span class="absolute left-3 top-2.5 text-slate-400"><i class="fa-solid fa-search"></i></span><input type="text" v-model="searchQuery" placeholder="搜尋名稱、IP、狀態..." class="w-full pl-10 pr-4 py-2 rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-colors text-sm"></div>
                        <div class="relative w-full sm:w-48">
                            <span class="absolute left-3 top-2.5 text-slate-400"><i class="fa-solid fa-location-dot"></i></span>
                            <select v-model="filterLocation" class="w-full pl-10 pr-8 py-2 rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-colors appearance-none cursor-pointer text-sm">
                                <option value="">所有位置 ({{ uniqueLocations.length }})</option>
                                <option v-for="loc in uniqueLocations" :key="loc" :value="loc">{{ loc }}</option>
                            </select>
                            <span class="absolute right-3 top-3 text-slate-400 pointer-events-none"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                        </div>
                        <div class="flex items-center gap-1 w-full sm:w-auto">
                            <div class="relative flex-1 sm:w-40">
                                <span class="absolute left-3 top-2.5 text-slate-400"><i class="fa-solid fa-arrow-down-short-wide"></i></span>
                                <select v-model="sortBy" class="w-full pl-9 pr-8 py-2 rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-colors appearance-none cursor-pointer text-sm">
                                    <option value="IP">IP 位址</option>
                                    <option value="Name">名稱</option>
                                    <option value="Status">狀態</option>
                                    <option value="Jobs">佇列數</option>
                                    <option value="Location">位置</option>
                                    <option value="PortName">連接埠</option>
                                    <option value="Driver">驅動程式</option>
                                </select>
                                <span class="absolute right-3 top-3 text-slate-400 pointer-events-none"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                            </div>
                            <button @click="sortDesc = !sortDesc" class="p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors shadow-sm" :title="sortDesc ? '降冪' : '升冪'"><i class="fa-solid" :class="sortDesc ? 'fa-arrow-down-z-a' : 'fa-arrow-up-a-z'"></i></button>
                        </div>
                    </div>
                    <div class="flex gap-2 flex-wrap justify-start mt-2 xl:mt-0">
                         <button @click="filterStatus = ''" :class="filterStatus === '' ? 'bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-900 border-transparent' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'" class="px-3 py-1 text-xs rounded-full border transition-all shadow-sm">全部</button>
                         <button @click="filterStatus = 'Ready'" :class="filterStatus === 'Ready' ? 'bg-emerald-600 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'" class="px-3 py-1 text-xs rounded-full border transition-all shadow-sm">就緒</button>
                         <button @click="filterStatus = 'Issue'" :class="filterStatus === 'Issue' ? 'bg-orange-600 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'" class="px-3 py-1 text-xs rounded-full border transition-all shadow-sm">異常+警告</button>
                         <button @click="filterStatus = 'Error'" :class="filterStatus === 'Error' ? 'bg-red-600 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'" class="px-3 py-1 text-xs rounded-full border transition-all shadow-sm">異常</button>
                         <button @click="filterStatus = 'Warning'" :class="filterStatus === 'Warning' ? 'bg-amber-500 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'" class="px-3 py-1 text-xs rounded-full border transition-all shadow-sm">警告</button>
                    </div>
                </div>

                <transition-group name="list" tag="div" v-if="filteredPrinters.length > 0" class="printer-grid-container grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-4 pb-20">
                    <div v-for="p in filteredPrinters" :key="p.Name" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4 hover:shadow-md transition-all relative group h-full">
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 rounded-l-xl" :class="getStatusColor(p.Status, true)"></div>
                        <div class="pl-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="overflow-hidden">
                                    <h3 class="font-bold text-slate-800 dark:text-slate-100 text-lg truncate pr-2" :title="p.Name">{{ p.Name }}</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium" :class="getStatusColor(p.Status)"><i class="fa-solid fa-circle text-[8px] mr-1.5"></i>{{ p.Status }}</span>
                                        <span v-if="p.IP" class="text-xs font-mono text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded"><i class="fa-solid fa-network-wired mr-1"></i>{{ p.IP }}</span>
                                    </div>
                                </div>
                                <div class="text-right flex-shrink-0 ml-2">
                                    <div class="text-2xl font-bold" :class="p.Jobs > 0 ? (p.Jobs > 20 ? 'text-red-600 dark:text-red-400' : 'text-blue-600 dark:text-blue-400') : 'text-slate-400 dark:text-slate-600'">{{ p.Jobs }}</div>
                                    <div class="text-[10px] text-slate-400 dark:text-slate-500 uppercase">佇列數</div>
                                </div>
                            </div>
                            <div v-if="p.ErrorDetails" class="mb-3 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 text-xs px-2 py-1.5 rounded border border-red-100 dark:border-red-900/50 flex items-start gap-2"><i class="fa-solid fa-triangle-exclamation mt-0.5"></i><span>{{ p.ErrorDetails }}</span></div>
                            <div v-if="p.Comment" class="mb-3 text-xs text-slate-500 dark:text-slate-400 italic"><i class="fa-regular fa-comment-dots mr-1"></i>{{ p.Comment }}</div>
                            <div class="grid grid-cols-2 gap-y-1 text-xs text-slate-500 dark:text-slate-400 mb-4 border-t border-slate-100 dark:border-slate-700 pt-2">
                                <div v-if="p.Location" class="truncate" :title="p.Location"><i class="fa-solid fa-location-dot w-4"></i> {{ p.Location }}</div>
                                <div v-if="p.ShareName" class="truncate" :title="p.ShareName"><i class="fa-solid fa-share-nodes w-4"></i> {{ p.ShareName }}</div>
                                <div v-if="p.Driver" class="truncate col-span-2" :title="p.Driver"><i class="fa-solid fa-microchip w-4"></i> {{ p.Driver }}</div>
                                <div v-if="p.PortName" class="truncate"><i class="fa-solid fa-plug w-4"></i> {{ p.PortName }}</div>
                            </div>
                            <div class="grid grid-cols-4 gap-2 mt-auto pt-2 border-t border-slate-100 dark:border-slate-700">
                                <button @click="refreshPrinter(p.Name)" :disabled="loading" class="bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200 text-xs py-2 rounded border border-slate-200 dark:border-slate-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><i class="fa-solid fa-sync" :class="{'fa-spin': loading}"></i> 刷新</button>
                                <button @click="openEditModal(p)" :disabled="loading" class="bg-yellow-50 dark:bg-yellow-900/20 hover:bg-yellow-100 dark:hover:bg-yellow-900/40 text-yellow-600 dark:text-yellow-400 text-xs py-2 rounded border border-yellow-200 dark:border-yellow-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><i class="fa-solid fa-pen-to-square"></i> 編輯</button>
                                <button v-if="p.Status === 'Ready'" @click="openPdfModal(p)" :disabled="loading" class="bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-300 text-xs py-2 rounded border border-blue-200 dark:border-blue-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><i class="fa-solid fa-file-pdf"></i> 列印</button>
                                <div v-else class="flex-1"></div>
                                <button @click="clearQueue(p.Name)" :disabled="loading" class="bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 text-red-600 dark:text-red-300 text-xs py-2 rounded border border-red-200 dark:border-red-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><i class="fa-solid fa-trash"></i> 清除</button>
                            </div>
                        </div>
                    </div>
                </transition-group>
                <div v-else-if="!loading" class="flex flex-col items-center justify-center h-96 text-slate-400 dark:text-slate-600"><i class="fa-solid fa-ghost text-4xl mb-4"></i><p>找不到符合的印表機</p></div>
                <div v-if="loading && printers.length === 0" class="absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-10"><div class="flex flex-col items-center"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-3"></i><p class="text-sm text-slate-500 dark:text-slate-400 font-medium">正在連線至 API...</p></div></div>
            </section>
        </main>

        <transition name="fade">
            <div v-if="showServerModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transition-colors flex flex-col max-h-[90vh]">
                    <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900"><h3 class="font-bold text-slate-700 dark:text-slate-200"><i class="fa-solid fa-server mr-2 text-blue-500"></i>伺服器管理</h3><button @click="showServerModal = false" :disabled="loading" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 disabled:opacity-50"><i class="fa-solid fa-xmark text-xl"></i></button></div>
                    <div class="flex-1 overflow-y-auto p-6">
                        <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700 mb-6">
                            <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">{{ editingServer.id ? '編輯伺服器' : '新增伺服器' }}</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-12 gap-3">
                                <div class="sm:col-span-3"><input type="text" v-model="editingServer.name" placeholder="名稱" class="w-full px-3 py-2 text-sm rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white"></div>
                                <div class="sm:col-span-4"><input type="text" v-model="editingServer.ip" placeholder="IP 位址" class="w-full px-3 py-2 text-sm rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white"></div>
                                <div class="sm:col-span-3"><input type="password" v-model="editingServer.key" placeholder="API Key" class="w-full px-3 py-2 text-sm rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white"></div>
                                <div class="sm:col-span-2 flex gap-1"><button @click="saveServer" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm"><i class="fa-solid fa-save"></i></button><button v-if="editingServer.id" @click="resetEdit" class="flex-1 bg-slate-400 hover:bg-slate-500 text-white rounded text-sm"><i class="fa-solid fa-rotate-left"></i></button></div>
                            </div>
                        </div>
                        <div v-if="servers.length === 0" class="text-center py-8 text-slate-400"><i class="fa-solid fa-database text-3xl mb-2"></i><p>尚無伺服器設定，請新增。</p></div>
                        <div v-else class="space-y-2">
                            <div v-for="srv in servers" :key="srv.id" class="flex items-center justify-between p-3 bg-white dark:bg-slate-700/50 border border-slate-100 dark:border-slate-600 rounded-lg hover:border-blue-300 dark:hover:border-blue-500 transition-colors group">
                                <div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full" :class="srv.id === currentServerId ? 'bg-emerald-500' : 'bg-slate-300'"></div><div><div class="font-bold text-slate-700 dark:text-slate-200 text-sm">{{ srv.name }}</div><div class="text-xs text-slate-500 dark:text-slate-400 font-mono">{{ srv.ip }}</div></div></div>
                                <div class="flex gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity"><button @click="useServer(srv)" v-if="srv.id !== currentServerId" class="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded" title="切換使用"><i class="fa-solid fa-plug"></i></button><button @click="editServer(srv)" class="p-1.5 text-slate-500 hover:text-blue-600 hover:bg-slate-100 dark:hover:bg-slate-600 rounded" title="編輯"><i class="fa-solid fa-pen"></i></button><button @click="removeServer(srv.id)" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded" title="刪除"><i class="fa-solid fa-trash"></i></button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showEditModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md overflow-hidden transition-colors">
                    <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900"><h3 class="font-bold text-slate-700 dark:text-slate-200"><i class="fa-solid fa-pen-to-square mr-2 text-yellow-500"></i>編輯資訊</h3><button @click="showEditModal = false" :disabled="saving" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 disabled:opacity-50 disabled:cursor-not-allowed"><i class="fa-solid fa-xmark"></i></button></div>
                    <div class="p-6 space-y-4">
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg text-sm text-yellow-800 dark:text-yellow-200 mb-4 border border-yellow-100 dark:border-yellow-900/50"><span class="font-bold">目標：</span> {{ editTarget?.Name }}</div>
                        <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">位置</label><input type="text" v-model="editLocation" class="block w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-yellow-500"></div>
                        <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">備註</label><textarea v-model="editComment" rows="3" class="block w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-yellow-500"></textarea></div>
                    </div>
                    <div class="px-6 py-4 bg-slate-50 dark:bg-slate-900 flex justify-end gap-3 border-t border-slate-100 dark:border-slate-800"><button @click="showEditModal = false" :disabled="saving" class="px-4 py-2 text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed">取消</button><button @click="submitEdit" :disabled="saving" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-sm font-medium disabled:opacity-50 flex items-center gap-2 shadow-lg shadow-yellow-500/20"><i v-if="saving" class="fa-solid fa-spinner fa-spin"></i>{{ saving ? '儲存中...' : '儲存變更' }}</button></div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showPdfModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md overflow-hidden transition-colors">
                    <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900"><h3 class="font-bold text-slate-700 dark:text-slate-200"><i class="fa-solid fa-print mr-2 text-blue-600 dark:text-blue-400"></i>上傳 PDF 列印</h3><button @click="showPdfModal = false" :disabled="uploading" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 disabled:opacity-50 disabled:cursor-not-allowed"><i class="fa-solid fa-xmark"></i></button></div>
                    <div class="p-6 space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-sm text-blue-800 dark:text-blue-200 mb-4"><span class="font-bold">目標：</span> {{ selectedPrinter?.Name }}</div>
                        <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">選擇檔案</label><input type="file" ref="fileInput" accept=".pdf" class="block w-full text-sm text-slate-500 dark:text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-900/50 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 transition-all border border-slate-200 dark:border-slate-600 rounded-lg cursor-pointer bg-white dark:bg-slate-700"></div>
                        <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">模式</label><div class="grid grid-cols-3 gap-2"><label class="cursor-pointer"><input type="radio" v-model="pdfDuplex" value="0" class="peer sr-only"><div class="text-center py-2 border dark:border-slate-600 rounded hover:bg-slate-50 dark:hover:bg-slate-700 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all text-sm text-slate-600 dark:text-slate-300">單面</div></label><label class="cursor-pointer"><input type="radio" v-model="pdfDuplex" value="1" class="peer sr-only"><div class="text-center py-2 border dark:border-slate-600 rounded hover:bg-slate-50 dark:hover:bg-slate-700 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all text-sm text-slate-600 dark:text-slate-300">雙面(長)</div></label><label class="cursor-pointer"><input type="radio" v-model="pdfDuplex" value="2" class="peer sr-only"><div class="text-center py-2 border dark:border-slate-600 rounded hover:bg-slate-50 dark:hover:bg-slate-700 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all text-sm text-slate-600 dark:text-slate-300">雙面(短)</div></label></div></div>
                    </div>
                    <div class="px-6 py-4 bg-slate-50 dark:bg-slate-900 flex justify-end gap-3 border-t border-slate-100 dark:border-slate-800">
                        <button @click="showPdfModal = false" :disabled="uploading" class="px-4 py-2 text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed">取消</button>
                        <button @click="submitPdf" :disabled="uploading" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium disabled:opacity-50 flex items-center gap-2 shadow-lg shadow-blue-500/20"><i v-if="uploading" class="fa-solid fa-spinner fa-spin"></i>{{ uploading ? '傳送中...' : '確認列印' }}</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showLogModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col transition-colors">
                    <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900"><h3 class="font-bold text-slate-700 dark:text-slate-200"><i class="fa-solid fa-terminal mr-2 text-emerald-600"></i>伺服器日誌</h3><div class="flex items-center gap-3"><button @click="fetchLogs" :disabled="logsLoading" class="text-sm text-blue-600 dark:text-blue-400 hover:underline disabled:opacity-50"><i class="fa-solid fa-sync mr-1" :class="{'fa-spin': logsLoading}"></i>重新整理</button><button @click="showLogModal = false" :disabled="logsLoading" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 disabled:opacity-50"><i class="fa-solid fa-xmark text-xl"></i></button></div></div>
                    <div class="flex-1 overflow-auto bg-slate-900 p-4 font-mono text-xs text-green-400 leading-relaxed whitespace-pre-wrap" id="logContent"><div v-if="logsLoading" class="text-center py-10 text-slate-500"><i class="fa-solid fa-spinner fa-spin text-2xl"></i><br>載入中...</div><div v-else>{{ logData || '暫無日誌資料...' }}</div></div>
                </div>
            </div>
        </transition>

    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const isDemoMode = ref(new URLSearchParams(window.location.search).get('demo') === '1');
                const config = ref({ ip: '', key: '' });
                const autoRefresh = ref(localStorage.getItem('ps_auto_refresh') === 'true');
                const refreshInterval = ref(parseInt(localStorage.getItem('ps_refresh_interval')) || 60);
                const darkMode = ref(localStorage.getItem('ps_dark_mode') === 'true');
                const countdown = ref(0);
                // [NEW] Toggle for advanced operations
                const showAdvancedOps = ref(false);

                const printers = ref([]);
                const loading = ref(false);
                const lastUpdated = ref('');
                const searchQuery = ref('');
                const filterStatus = ref('');
                const filterLocation = ref('');
                const sortBy = ref('IP');
                const sortDesc = ref(false);
                const servers = ref([]);
                const currentServerId = ref('');
                
                const showServerModal = ref(false);
                const editingServer = ref({ id: null, name: '', ip: '', key: '' });
                const showEditModal = ref(false);
                const editTarget = ref(null);
                const editLocation = ref('');
                const editComment = ref('');
                const saving = ref(false);
                const showPdfModal = ref(false);
                const selectedPrinter = ref(null);
                const pdfDuplex = ref("0");
                const uploading = ref(false);
                const fileInput = ref(null);
                const showLogModal = ref(false);
                const logData = ref('');
                const logsLoading = ref(false);
                
                const downloadFiles = [
                    { name: '列印伺服器監控腳本', url: 'server/Printer_API_Agent.ps1', icon: 'fa-solid fa-terminal text-blue-500' },
                    { name: '簡易說明', url: 'server/Printer_API_Agent.txt', icon: 'fa-regular fa-file-lines text-slate-500' },
                    { name: 'API 測試指令集', url: 'server/Printer_API_Agent_API測試指令集.pdf', icon: 'fa-solid fa-file-pdf text-red-500' },
                    { name: '部署指南', url: 'server/Printer_API_Agent_Windows_Server_部署指南.pdf', icon: 'fa-solid fa-book text-emerald-500' }
                ];
                let pollTimer = null;

                const generateMockData = () => {
                    const locations = ['1F 櫃台', '2F 會議室', '3F 研發部', '3F 測試區', '4F 財務部'];
                    const statuses = ['Ready', 'Printing', 'Offline', 'Error', 'Warning'];
                    const mocks = [];
                    for(let i=1; i<=12; i++) {
                        const s = statuses[Math.floor(Math.random() * statuses.length)];
                        mocks.push({
                            Name: `Office-Printer-${String(i).padStart(2,'0')}`,
                            Status: s, Jobs: s==='Printing' ? Math.floor(Math.random()*5)+1 : 0, IP: `192.168.1.${100+i}`,
                            Location: locations[i%locations.length], Comment: `資產編號: A-${202300+i}`,
                            Driver: 'HP Universal Printing PCL 6', PortName: `IP_192.168.1.${100+i}`, ShareName: `PRINTER_${i}`,
                            ErrorDetails: s==='Error' ? '缺紙 (Tray 2)' : (s==='Warning' ? '碳粉存量低' : '')
                        });
                    }
                    return mocks;
                };

                const isConfigValid = computed(() => isDemoMode.value || (config.value.ip && config.value.key));

                watch(currentServerId, (newId) => {
                    const srv = servers.value.find(s => s.id === newId);
                    if (srv) { 
                        config.value.ip = srv.ip; config.value.key = srv.key; 
                        localStorage.setItem('ps_last_server_id', newId); 
                        fetchPrinters(true); 
                        if (autoRefresh.value) startPolling();
                    }
                    else { config.value.ip = ''; config.value.key = ''; printers.value = []; }
                });
                watch(autoRefresh, (newVal) => { 
                    localStorage.setItem('ps_auto_refresh', newVal); 
                    if (newVal && isConfigValid.value) { startPolling(); toast(`已啟用自動更新 (${refreshInterval.value}s)`); } 
                    else { stopPolling(); toast("自動更新已停用"); } 
                });
                watch(darkMode, (val) => { localStorage.setItem('ps_dark_mode', val); document.documentElement.classList.toggle('dark', val); }, { immediate: true });

                const toggleDarkMode = () => darkMode.value = !darkMode.value;
                const validateInterval = () => { if (refreshInterval.value < 60) refreshInterval.value = 60; localStorage.setItem('ps_refresh_interval', refreshInterval.value); if (autoRefresh.value) startPolling(); };
                
                function startPolling() {
                    if (pollTimer) clearInterval(pollTimer);
                    countdown.value = refreshInterval.value;
                    pollTimer = setInterval(() => {
                        countdown.value--;
                        if (countdown.value <= 0) { fetchPrinters(false); countdown.value = refreshInterval.value; }
                    }, 1000);
                }
                function stopPolling() { if (pollTimer) clearInterval(pollTimer); }

                const getApiUrl = (path) => `http://${config.value.ip}:8888${path}`;

                const loadServers = () => {
                    if (isDemoMode.value) { servers.value = [{ id: 999, name: 'DEMO Server', ip: '127.0.0.1', key: 'demo' }]; currentServerId.value = 999; return; }
                    const stored = localStorage.getItem('ps_servers_list');
                    if (stored) servers.value = JSON.parse(stored);
                    else {
                        const oldIp = localStorage.getItem('ps_server_ip');
                        if (oldIp) { const newSrv = { id: Date.now(), name: '預設伺服器', ip: oldIp, key: localStorage.getItem('ps_api_key')||'' }; servers.value = [newSrv]; saveServers(); currentServerId.value = newSrv.id; }
                    }
                    const lastId = localStorage.getItem('ps_last_server_id');
                    if (lastId && servers.value.find(s => s.id == lastId)) currentServerId.value = parseInt(lastId);
                };
                const saveServers = () => localStorage.setItem('ps_servers_list', JSON.stringify(servers.value));

                const openServerManager = () => { if(isDemoMode.value) return toast("Demo 模式下無法管理伺服器", "#f59e0b"); resetEdit(); showServerModal.value = true; };
                const resetEdit = () => { editingServer.value = { id: null, name: '', ip: '', key: '' }; };
                const editServer = (srv) => { editingServer.value = { ...srv }; };
                const saveServer = () => {
                    if (!editingServer.value.name || !editingServer.value.ip) return toast("請填寫完整", "#ef4444");
                    if (editingServer.value.id) { const idx = servers.value.findIndex(s => s.id === editingServer.value.id); if (idx !== -1) servers.value[idx] = { ...editingServer.value }; }
                    else { servers.value.push({ ...editingServer.value, id: Date.now() }); }
                    saveServers(); if (servers.value.length === 1) useServer(servers.value[0]);
                    resetEdit(); toast("儲存成功", "#10b981");
                };
                const removeServer = (id) => { if (confirm("刪除？")) { servers.value = servers.value.filter(s => s.id !== id); saveServers(); if (currentServerId.value === id) { currentServerId.value = ''; printers.value = []; } } };
                const useServer = (srv) => { currentServerId.value = srv.id; showServerModal.value = false; fetchPrinters(true); };
                const switchServer = () => { if (currentServerId.value) fetchPrinters(true); };

                const fetchSinglePrinter = async (name) => {
                    if (isDemoMode.value) return; 
                    try {
                        const res = await axios.get(getApiUrl(`/printer/status?name=${encodeURIComponent(name)}`), { headers: { 'X-API-KEY': config.value.key } });
                        if (res.data.success) {
                            const idx = printers.value.findIndex(p => p.Name === name);
                            if (idx !== -1) printers.value[idx] = res.data.data;
                            lastUpdated.value = new Date().toLocaleString();
                        }
                    } catch (e) { console.error(e); }
                };

                const fetchPrinters = async (showToast = false) => {
                    if (!isConfigValid.value) { if (showToast) error("請選擇伺服器"); return; }
                    loading.value = true;
                    if (autoRefresh.value) countdown.value = refreshInterval.value;
                    
                    if (isDemoMode.value) {
                        setTimeout(() => {
                            if (printers.value.length === 0) printers.value = generateMockData();
                            else {
                                printers.value.forEach(p => {
                                    if (Math.random() > 0.7) {
                                        const s = ['Ready', 'Printing', 'Offline'][Math.floor(Math.random()*3)];
                                        p.Status = s; p.Jobs = s==='Printing' ? Math.floor(Math.random()*10) : 0;
                                    }
                                });
                            }
                            lastUpdated.value = new Date().toLocaleString();
                            if (showToast) success("Demo 連線成功");
                            loading.value = false;
                            const l = document.getElementById('init-loading'); if(l) { l.classList.add('fade-out'); setTimeout(()=>l.remove(),500); }
                        }, 800);
                        return;
                    }
                    try {
                        const res = await axios.get(getApiUrl('/printers'), { headers: { 'X-API-KEY': config.value.key } });
                        if (res.data.success) {
                            printers.value = res.data.data;
                            lastUpdated.value = new Date().toLocaleString();
                            if (showToast) success("連線成功");
                        } else { error(res.data.message); }
                    } catch (err) { error("連線失敗"); autoRefresh.value = false; }
                    finally { 
                        loading.value = false;
                        const l = document.getElementById('init-loading'); if(l) { l.classList.add('fade-out'); setTimeout(()=>l.remove(),500); }
                    }
                };

                const handleDownload = (e) => {
                    if (isDemoMode.value) {
                        e.preventDefault();
                        toast("Demo 模式無法下載檔案", "#f59e0b");
                    }
                };

                const performAction = async (endpoint, successMsg, targetName = null) => {
                    loading.value = true;
                    if (isDemoMode.value) {
                        setTimeout(() => {
                            success("[Demo] " + successMsg);
                            loading.value = false;
                            if (targetName) {
                                const p = printers.value.find(x => x.Name === targetName);
                                if (p && endpoint.includes('clear')) p.Jobs = 0;
                            }
                        }, 600);
                        return;
                    }
                    try {
                        const res = await axios.get(getApiUrl(endpoint), { headers: { 'X-API-KEY': config.value.key } });
                        if (res.data.success) {
                            success(res.data.message || successMsg);
                            if (targetName) fetchSinglePrinter(targetName); else fetchPrinters(false);
                        } else { error(res.data.message); }
                    } catch (err) { error("失敗: " + err.message); } finally { loading.value = false; }
                };

                const clearQueue = (name) => { if(confirm("清除佇列？")) performAction(`/printer/clear?name=${encodeURIComponent(name)}`, "佇列已清除", name); };
                const refreshPrinter = (name) => performAction(`/printer/refresh?name=${encodeURIComponent(name)}`, "指令已發送", name);
                const restartSpooler = () => { if(confirm("重啟 Spooler？")) performAction(`/service/restart-spooler`, "服務重啟中"); };
                const selfHeal = () => { if(confirm("執行深度自癒？")) performAction(`/service/self-heal`, "自癒流程啟動"); };
                
                // Advanced Ops Wrappers
                const restartScript = () => { 
                    if(confirm("重啟 API？")) {
                        if(isDemoMode.value) return toast("Demo 模式無法重啟", "#f59e0b");
                        axios.get(getApiUrl('/server/restart-script'), { headers: { 'X-API-KEY': config.value.key } }).catch(()=>{});
                        success("重啟中..."); setTimeout(()=>fetchPrinters(), 5000);
                    }
                };
                
                const restartServer = () => {
                    if(confirm("警告：這將會重新啟動整台實體伺服器/虛擬機。所有服務將會中斷。確定要繼續嗎？")) {
                        if(isDemoMode.value) return toast("Demo 模式無法重啟電腦", "#f59e0b");
                        axios.get(getApiUrl('/server/restart-computer'), { headers: { 'X-API-KEY': config.value.key } })
                            .then(res => {
                                if(res.data.success) success("重啟指令已發送 (5秒後重啟)");
                                else error(res.data.message);
                            })
                            .catch(e => error("重啟失敗: " + e.message));
                    }
                };

                const openEditModal = (p) => { editTarget.value = p; editLocation.value = p.Location||''; editComment.value = p.Comment||''; showEditModal.value = true; };
                const submitEdit = async () => {
                    if (isDemoMode.value) {
                        editTarget.value.Location = editLocation.value;
                        editTarget.value.Comment = editComment.value;
                        showEditModal.value = false; success("[Demo] 更新成功"); return;
                    }
                    saving.value = true;
                    try {
                        const url = getApiUrl(`/printer/update?name=${encodeURIComponent(editTarget.value.Name)}&location=${encodeURIComponent(editLocation.value)}&comment=${encodeURIComponent(editComment.value)}`);
                        const res = await axios.get(url, { headers: { 'X-API-KEY': config.value.key } });
                        if (res.data.success) {
                            success("更新成功"); showEditModal.value = false;
                            // Optimistic update
                            editTarget.value.Location = editLocation.value; editTarget.value.Comment = editComment.value;
                        } else error(res.data.message);
                    } catch(e) { error(e.message); } finally { saving.value = false; }
                };

                const openPdfModal = (p) => { selectedPrinter.value = p; pdfDuplex.value = "0"; showPdfModal.value = true; };
                const submitPdf = async () => {
                    if (!fileInput.value.files[0]) return error("請選擇檔案");
                    uploading.value = true;
                    if (isDemoMode.value) {
                        setTimeout(() => { success("[Demo] PDF 已列印"); showPdfModal.value = false; uploading.value = false; }, 1000);
                        return;
                    }
                    try {
                        const url = getApiUrl(`/printer/print-pdf?name=${encodeURIComponent(selectedPrinter.value.Name)}&duplex=${pdfDuplex.value}`);
                        const res = await axios.post(url, fileInput.value.files[0], { headers: { 'X-API-KEY': config.value.key, 'Content-Type': 'application/pdf' } });
                        if (res.data.success) { success("PDF 已傳送"); showPdfModal.value = false; setTimeout(() => fetchSinglePrinter(selectedPrinter.value.Name), 1000); }
                        else error(res.data.message);
                    } catch(e) { error(e.message); } finally { uploading.value = false; }
                };

                const showLogs = () => { showLogModal.value = true; fetchLogs(); };
                const fetchLogs = async () => {
                    logsLoading.value = true;
                    if (isDemoMode.value) {
                        setTimeout(() => {
                            logData.value = `[${new Date().toLocaleTimeString()}] >>> [Demo] System Initialized\n[${new Date().toLocaleTimeString()}] >>> [Demo] Monitor Started\n... (Simulation)`;
                            logsLoading.value = false;
                        }, 500);
                        return;
                    }
                    try {
                        const res = await axios.get(getApiUrl('/server/logs?lines=500'), { headers: { 'X-API-KEY': config.value.key } });
                        if (res.data.success) {
                            logData.value = Array.isArray(res.data.data) ? res.data.data.join('\n') : res.data.data;
                            setTimeout(() => { const el = document.getElementById('logContent'); if(el) el.scrollTop = el.scrollHeight; }, 100);
                        } else logData.value = res.data.message;
                    } catch(e) { logData.value = e.message; } finally { logsLoading.value = false; }
                };

                const uniqueLocations = computed(() => [...new Set(printers.value.map(p => p.Location).filter(l => l))].sort());
                const filteredPrinters = computed(() => {
                    return printers.value.filter(p => {
                        const matchQ = p.Name.toLowerCase().includes(searchQuery.value.toLowerCase()) || p.IP.includes(searchQuery.value);
                        let matchS = true;
                        if (filterStatus.value === 'Ready') matchS = p.Status === 'Ready';
                        else if (filterStatus.value === 'Error') matchS = p.Status === 'Error';
                        else if (filterStatus.value === 'Warning') matchS = p.Status.includes('Warning');
                        else if (filterStatus.value === 'Issue') matchS = p.Status === 'Error' || p.Status.includes('Warning');
                        const matchL = filterLocation.value ? p.Location === filterLocation.value : true;
                        return matchQ && matchS && matchL;
                    }).sort((a,b) => {
                        let valA = a[sortBy.value]||'', valB = b[sortBy.value]||'';
                        // [Fix] Status Priority Sorting
                        if (sortBy.value === 'Status') {
                             const getWeight = (s) => {
                                 s = s.toLowerCase();
                                 if (s === 'ready') return 50; 
                                 if (s.includes('printing') || s.includes('warmup')) return 40;
                                 if (s.includes('warning')) return 30;
                                 if (s.includes('offline')) return 20;
                                 if (s.includes('error')) return 10; 
                                 return 0; 
                             };
                             const wA = getWeight(valA);
                             const wB = getWeight(valB);
                             if (wA !== wB) return sortDesc.value ? wB - wA : wA - wB; 
                             return a.Name.localeCompare(b.Name);
                        }
                        if(sortBy.value==='IP') {
                             const iA=valA.split('.').map(Number), iB=valB.split('.').map(Number);
                             if(iA.length===4 && iB.length===4) for(let i=0;i<4;i++) if(iA[i]!==iB[i]) return sortDesc.value ? iB[i]-iA[i] : iA[i]-iB[i];
                        }
                        if(sortBy.value==='Jobs') return sortDesc.value ? valB-valA : vA-vB;
                        return sortDesc.value ? (valA<valB?1:-1) : (valA>valB?1:-1);
                    });
                });
                const errorCount = computed(() => printers.value.filter(p => p.Status === 'Error' || p.Status.includes('Warning')).length);

                const getStatusColor = (s, b) => {
                    if (s === 'Ready') return b ? 'bg-emerald-500' : 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400';
                    if (s === 'Printing') return b ? 'bg-blue-500' : 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400 animate-pulse';
                    if (s === 'Offline') return b ? 'bg-slate-400' : 'bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-400';
                    if (s.includes('Error')) return b ? 'bg-red-500' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400';
                    return b ? 'bg-amber-500' : 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400';
                };

                const toast = (text, bg="#3b82f6") => Toastify({text, duration:3000, gravity:"bottom", position:"right", style:{background:bg, borderRadius:"8px", fontSize:"14px"}}).showToast();
                const success = (t) => toast(t, "#10b981"); const error = (t) => toast(t, "#ef4444");

                onMounted(() => {
                    loadServers();
                    const loader = document.getElementById('init-loading');
                    if (loader) { loader.classList.add('fade-out'); setTimeout(() => loader.remove(), 500); }
                    if (isConfigValid.value) { fetchPrinters(); if (autoRefresh.value) startPolling(); }
                });

                return {
                    config, servers, currentServerId, showServerModal, editingServer, printers, loading, lastUpdated, autoRefresh, darkMode, isConfigValid, isDemoMode,
                    searchQuery, filterStatus, filterLocation, uniqueLocations, filteredPrinters, errorCount, sortBy, sortDesc, refreshInterval, validateInterval, countdown,
                    getStatusColor, toggleDarkMode, openServerManager, saveServer, removeServer, useServer, resetEdit, editServer, switchServer,
                    fetchPrinters, fetchSinglePrinter, clearQueue, refreshPrinter, restartSpooler, selfHeal, restartScript, restartServer, 
                    showEditModal, editTarget, editLocation, editComment, saving, openEditModal, submitEdit, 
                    showPdfModal, selectedPrinter, pdfDuplex, uploading, fileInput, openPdfModal, submitPdf,
                    showLogModal, logData, logsLoading, showLogs, fetchLogs, downloadFiles, handleDownload,
                    uniqueLocations, filteredPrinters, errorCount, getStatusColor,
                    showAdvancedOps // [NEW] for advanced ops toggle
                };
            }
        }).mount('#app');
    </script>
</body>
</html>